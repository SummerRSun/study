*** Settings ***
Library           RequestsLibrary
Library           DatabaseLibrary
Library           Collections

*** Variables ***
${URL}            http://10.1.50.225:7000/boltdog
&{Header}         x-uyun-login-token=3cc40c1b2ded40958ff64efbd291707e
@{boltdogmysql}    database='boltdog', user='root',password='123456',host='10.1.50.225',port=3306
${linux_minio_name}    salt-minio-centos7
${window_minio_name}    WIN-R9AQ3MMMAV9
${action_name}    ljtest
${file_name}      batch.bat

*** Test Cases ***
action_filelist
    [Documentation]    Request URL:http://10.1.50.225:7000/boltdog/api/v1/action/query
    ...    Request Method:GET
    ...    Response Date:{"data":[{"createTime":1463476332000,"createUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"execInfo":{"code":"scriptExecutor","name":"","url":""},"id":76,"modifyTime":1463476493000,"modifyUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"name":"测试一个操作","paramObj":null,"status":0,"tags":"ac ,ccc","type":2,"usage":"wenj"},{"createTime":1463470787000,"createUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"execInfo":{"code":"scriptExecutor","name":"","url":""},"id":75,"modifyTime":1463470787000,"modifyUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"name":"ljtest","paramObj":null,"status":1,"tags":"","type":2,"usage":""}],"total":2}
    Create Session    action_filelist_api    ${URL}
    ${addr}    Get Request    action_filelist_api    /api/v1/action/query    headers=&{Header}
    Should Be Equal As Strings    ${addr.status_code}    200
    Log    ${addr.content}
    ${responsedata}    To Json    ${addr.content}
    ${keys}    Get Dictionary Keys    ${responsedata}
    ${items}    Get Dictionary Items    ${responsedata}
    ${values}    Get Dictionary Values    ${responsedata}
    ${data}    Get From Dictionary    ${responsedata}    data
    ${num}    get length    ${data}
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${res_total}    query    select count(*) from action
    ${name}    query    select name from action \ ORDER BY create_time DESC limit ${num}
    Disconnect From Database
    Dictionary Should Contain Item    ${responsedata}    total    ${res_total[0][0]}    msg=total is not right
    ${items_name_list}    Create List
    : FOR    ${i}    IN RANGE    ${num}
    \    ${items_tmp}    Get From Dictionary    ${items[1][${i}]}    name
    \    Append To List    ${items_name_list}    ${items_tmp}
    Sort List    ${items_name_list}
    ${mysql_name_list}    Create List
    : FOR    ${i}    IN RANGE    ${num}
    \    Append To List    ${mysql_name_list}    ${name[${i}][0]}
    Sort List    ${mysql_name_list}
    Lists Should Be Equal    ${items_name_list}    ${mysql_name_list}    msg=None    values=True    names=None

action_query
    [Documentation]    Request URL:http://10.1.50.225:7000/boltdog/api/v1/action/query?name=ljtest
    ...    Request Method:GET
    ...    Response Date:{"data":[{"createTime":1463470787000,"createUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"execInfo":{"code":"scriptExecutor","name":"","url":""},"id":75,"modifyTime":1463470787000,"modifyUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"name":"ljtest","paramObj":null,"status":1,"tags":"","type":2,"usage":""}],"total":1}
    Create Session    resource_query_api    ${URL}
    ${addr}    Get Request    resource_query_api    /api/v1/action/query?name=${action_name}    headers=&{Header}
    Should Be Equal As Strings    ${addr.status_code}    200
    Log    ${addr.content}
    ${responsedata}    To Json    ${addr.content}
    ${keys}    Get Dictionary Keys    ${responsedata}
    ${items}    Get Dictionary Items    ${responsedata}
    ${values}    Get Dictionary Values    ${responsedata}
    ${data}    Get From Dictionary    ${responsedata}    data
    ${num}    get length    ${data}
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${res_total}    query    select count(*) from action where name like '%${action_name}%'
    ${name}    query    select name from action where name like '%${action_name}%'
    Disconnect From Database
    Dictionary Should Contain Item    ${responsedata}    total    ${res_total[0][0]}    msg=total is not right
    ${items_name_list}    Create List
    : FOR    ${i}    IN RANGE    ${num}
    \    ${items_tmp}    Get From Dictionary    ${items[1][${i}]}    name
    \    Append To List    ${items_name_list}    ${items_tmp}
    Sort List    ${items_name_list}
    ${mysql_name_list}    Create List
    : FOR    ${i}    IN RANGE    ${num}
    \    Append To List    ${mysql_name_list}    ${name[${i}][0]}
    Sort List    ${mysql_name_list}
    Lists Should Be Equal    ${items_name_list}    ${mysql_name_list}    msg=None    values=True    names=None

action_detail
    [Documentation]    Request URL:http://10.1.50.225:7000/boltdog/api/v1/action/get?id=75
    ...    Request Method:GET
    ...    Response Date:{"createTime":1463470787000,"createUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"execInfo":{"code":"scriptExecutor","name":"","url":""},"id":75,"modifyTime":1463470787000,"modifyUser":{"realname":"yetao","userId":"3cc40c1b2ded40958ff64efbd291707e"},"name":"ljtest","paramObj":{"inputParam":[{"name":"test1","description":"1","type":"number","value":"1"},{"name":"test2","description":"2","type":"text","value":"2"},{"name":"test3","description":"3","type":"file","value":[{"name":"userone.sql","id":"ff0e6fb0-952c-450a-9a7f-b95d8b52b88f"}]}],"script":{"id":"86b43d33-6418-44c6-9adf-0c5c3f128248","type":"Python","content":"print 123"}},"status":0,"tags":"","type":2,"usage":""}
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${action_id}    query    select id from action where name ='${action_name}'
    Disconnect From Database
    log    select id from action where name ='${action_name}'
    Create Session    action_detail_api    ${URL}
    ${addr}    Get Request    action_detail_api    /api/v1/action/get?id=75    headers=&{Header}
    Should Be Equal As Strings    ${addr.status_code}    200
    Log    ${addr.content}
    ${responsedata}    To Json    ${addr.content}
    ${keys}    Get Dictionary Keys    ${responsedata}
    ${items}    Get Dictionary Items    ${responsedata}
    ${values}    Get Dictionary Values    ${responsedata}
    ${Tags}    Get From Dictionary    ${responsedata}    tags
    ${name}    Get From Dictionary    ${responsedata}    name
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${name_sql}    query    select name from action where name = '${action_name}'
    ${Tags_sql}    query    select tags from action where name='${action_name}'
    Disconnect From Database
    Should Be Equal As Strings    ${Tags}    ${Tags_sql[0][0]}    Tags is not right
    Should Be Equal As Strings    ${name}    ${name_sql[0][0]}    name is not right

action_create
    [Documentation]    Request URL:http://10.1.50.225:7000/boltdog/api/v1/action/save
    ...    Request Method:POST
    ...    Request Payload:{"id":"","name":"1","usage":"123","tags":"","execInfo":{"code":"scriptExecutor"},"paramObj":{"inputParam":[{"name":"1","value":"2","type":"number","description":"3"},{"name":"1","value":"2","type":"text","description":"3"},{"name":"1","value":[{"id":"583fa6e4-0646-41d4-9367-ae90032d9dd0","name":"zabbix_监控配置.txt"}],"type":"file","description":"3"}],"script":{"type":"Python","content":"print 1"}}}
    ...    Response Data:{"id":77}
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${fileid}    query    select id from file_hub where file_name='${file_name}' ORDER BY create_time DESC limit 1
    Disconnect From Database
    Create Session    action_create_api    ${URL}
    ${addr}    POST Request    action_create_api    /api/v1/action/save    data={"id":"","name":"1","usage":"123","tags":"","execInfo":{"code":"scriptExecutor"},"paramObj":{"inputParam":[{"name":"1","value":"2","type":"number","description":"3"},{"name":"1","value":"2","type":"text","description":"3"},{"name":"1","value":[{"id":"${fileid[0][0]}","name":"${file_name}"}],"type":"file","description":"3"}],"script":{"type":"Python","content":"print 1"}}}    headers=&{Header}
    Should Be Equal As Strings    ${addr.status_code}    200
    Log    ${addr.content}
    ${responsedata}    To Json    ${addr.content}
    ${keys}    Get Dictionary Keys    ${responsedata}
    ${items}    Get Dictionary Items    ${responsedata}
    ${values}    Get Dictionary Values    ${responsedata}
    ${Tags}    Get From Dictionary    ${responsedata}    tags
    ${name}    Get From Dictionary    ${responsedata}    name
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${name_sql}    query    select name from action where name = '${action_name}'
    ${Tags_sql}    query    select tags from action where name='${action_name}'
    Disconnect From Database
    Should Be Equal As Strings    ${Tags}    ${Tags_sql[0][0]}    Tags is not right
    Should Be Equal As Strings    ${name}    ${name_sql[0][0]}    name is not right

action_del
    [Documentation]    Request URL:http://10.1.50.225:7000/boltdog/api/v1/action/delete?id=75
    ...    Request Method:POST
    ...    Data:[]
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${actionid}    query    select id from action ORDER BY create_time DESC limit 1
    Disconnect From Database
    Create Session    action_del_api    ${URL}
    ${addr}    Post Request    action_del_api    /api/v1/action/delete?id=${actionid[0][0]}    headers=&{Header}
    Should Be Equal As Strings    ${addr.status_code}    200
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${res_total}    query    select count(*) from action where id='${actionid[0][0]}'
    Disconnect From Database
    Should Be Equal As Strings    ${res_total[0][0]}    0    msg=failed to del action
    [Teardown]

action_delete-batch
    [Documentation]    Request URL:http://10.1.50.225:7000/boltdog/api/v1/action/delete-batch?ids=79
    ...    Request Method:POST
    ...    Data:[]
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${actionid}    query    select id from action ORDER BY create_time DESC limit 1
    Disconnect From Database
    Create Session    action_delete-batch_api    ${URL}
    ${addr}    Post Request    action_delete-batch_api    /api/v1/action/delete-batch?ids=${actionid[0][0]}    headers=&{Header}
    Should Be Equal As Strings    ${addr.status_code}    200
    Connect To Database Using Custom Params    pymysql    @{boltdogmysql}
    ${res_total}    query    select count(*) from action where id='${actionid[0][0]}'
    Disconnect From Database
    Should Be Equal As Strings    ${res_total[0][0]}    0    msg=failed to del action
    [Teardown]
